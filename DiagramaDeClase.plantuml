@startuml

' ===== ENTIDADES DE DOMINIO =====
package "Domain" {
  class Usuario {
    - id: String
    - nombres: String
    - apellidos: String
    - correo: String
    - password: String
    - rol: String
    - debeCambiarPassword: boolean
  }

  class Profesor {
    - id: String
    - nombres: String
    - apellidos: String
    - correo: String
  }

  class Ayudante {
    - id: String
    - nombres: String
    - apellidos: String
    - correoInstitucional: String
    - facultad: String
    - quintil: int
    - tipoAyudante: String
  }

  class Contrato {
    - id: String
    - proyectoId: String
    - ayudanteId: String
    - fechaInicio: String
    - fechaFin: String
    - estado: String
    - motivoInactivo: String
  }

  class Proyecto {
    - id: String
    - codigo: String
    - nombre: String
    - directorCorreo: String
    - activo: boolean
    - maxAyudantes: int
    - maxArticulos: int
    - fechaInicio: String
    - fechaFin: String
    - tipo: String
    - subtipo: String
  }

  class BitacoraMensual {
    - id: String
    - contratoId: String
    - anio: int
    - mes: int
    - estado: String
    - comentarioRevision: String
  }

  class InformeSemanal {
    - id: String
    - bitacoraId: String
    - fechaInicioSemana: String
    - fechaFinSemana: String
    - actividadesRealizadas: String
    - observaciones: String
    - anexos: String
  }

  class Actividad {
    - id: String
    - semanaId: String
    - horaInicio: String
    - horaSalida: String
    - totalHoras: double
    - descripcion: String
  }
}

' ===== REPOSITORIOS =====
package "Repository" {
  class UsuarioRepo {
    - jdbc: JdbcTemplate
    + findByCorreo(correo: String): Optional<Usuario>
    + existsByCorreo(correo: String): boolean
    + crearUsuario(nombres, apellidos, correo, password, rol): void
    + cambiarPassword(correo, nuevaPassword): void
  }

  class ProfesorRepo {
    - jdbc: JdbcTemplate
    + findAll(): List<Profesor>
    + findByCorreo(correo: String): Optional<Profesor>
  }

  class AyudanteRepo {
    - jdbc: JdbcTemplate
    + findByCorreoInstitucional(correo: String): Optional<Ayudante>
    + crear(ayudante: Ayudante): String
  }

  class ProyectoRepo {
    - jdbc: JdbcTemplate
    + crear(codigo, nombre, correoDirector): String
    + findAll(): List<Map>
    + listarResumen(): List<Map>
    + actualizarDetalles(...): int
    + obtenerMaxAyudantes(proyectoId): Integer
    + estadisticasPorTipoYEstado(): List<Map>
    + obtenerBasicoPorId(proyectoId): Map
  }

  class ContratoRepo {
    - jdbc: JdbcTemplate
    + crear(proyectoId, ayudanteId, fechaInicio, fechaFin): String
    + listarPorProyecto(proyectoId): List<Map>
    + finalizar(contratoId, motivo): void
    + contarActivosPorProyecto(proyectoId): int
    + contarActivosGlobal(): int
    + obtenerContratoActivoPorCorreo(correo): String
    + listarActivosDetallado(): List<Map>
  }

  class BitacoraRepo {
    - jdbc: JdbcTemplate
    + obtenerOCrearActual(contratoId): String
    + obtenerDetalle(bitacoraId): Map
    + obtenerEstado(bitacoraId): String
    + perteneceAContrato(bitacoraId, contratoId): boolean
    + enviar(bitacoraId): int
    + revisar(bitacoraId, nuevoEstado, comentario): int
    + contarAprobadasEnRango(...): int
    + directorPuedeRevisarBitacora(...): boolean
    + listarPendientesPorProyectoParaDirector(...): List<Map>
  }

  class InformeSemanalRepo {
    - jdbc: JdbcTemplate
    + crear(...): String
    + listarPorBitacora(bitacoraId): List<Map>
    + contarPorBitacora(bitacoraId): int
    + obtenerBitacoraIdPorSemana(semanaId): String
  }

  class ActividadRepo {
    - jdbc: JdbcTemplate
    + crear(semanaId, horaInicio, horaSalida, totalHoras, descripcion): String
    + listarPorSemana(semanaId): List<Map>
    + contarPorBitacora(bitacoraId): int
  }
}

' ===== CONTROLADORES =====
package "Controller" {
  class AuthController {
    - usuarioRepo: UsuarioRepo
    + cambiarPassword(principal, req): Map
  }

  class JefaturaController {
    - proyectoRepo: ProyectoRepo
    - usuarioRepo: UsuarioRepo
    - profesorRepo: ProfesorRepo
    - contratoRepo: ContratoRepo
    - bitacoraRepo: BitacoraRepo
    - notificacion: NotificacionPort
    + crearProyecto(req): Map
    + listarProyectos(): List
    + listarProfesores(): List
    + resumenProyectos(): Map
    + totalActivos(): Map
    + estadisticasAyudantes(): Map
    + estadisticasProyectos(): Map
    + semaforo(): List
    + listarAyudantesProyecto(proyectoId): List
  }

  class DirectorController {
    - jdbc: JdbcTemplate
    + misProyectos(principal): List<Map>
  }

  class DirectorProyectoController {
    - proyectoRepo: ProyectoRepo
    + actualizar(proyectoId, req): Map
  }

  class DirectorAyudantesController {
    - ayudanteRepo: AyudanteRepo
    - contratoRepo: ContratoRepo
    - usuarioRepo: UsuarioRepo
    - proyectoRepo: ProyectoRepo
    - notificacion: NotificacionPort
    + listar(proyectoId): List
    + registrar(proyectoId, req): Map
    + finalizar(contratoId, req): Map
  }

  class DirectorBitacoraController {
    - bitacoraRepo: BitacoraRepo
    - informeRepo: InformeSemanalRepo
    - actividadRepo: ActividadRepo
    + verBitacora(bitacoraId, principal): Map
    + revisar(bitacoraId, req, principal): Map
    + pendientes(proyectoId, principal): List
  }

  class AyudanteBitacoraController {
    - contratoRepo: ContratoRepo
    - bitacoraRepo: BitacoraRepo
    - informeRepo: InformeSemanalRepo
    - actividadRepo: ActividadRepo
    + obtenerBitacoraActual(principal): Map
    + crearSemana(bitacoraId, req, principal): Map
    + crearActividad(semanaId, req, principal): Map
    + verBitacora(bitacoraId, principal): Map
    + listarSemanas(bitacoraId, principal): Map
    + listarActividades(semanaId, principal): Map
    + enviar(bitacoraId, principal): Map
  }

  class CommonController {
    - usuarioRepo: UsuarioRepo
    + health(): Map
    + me(principal): Map
  }

  class DebugController {
    - repo: UsuarioRepo
    + usuario(correo): Map
  }

  class BitacoraDebugController {
    - jdbc: JdbcTemplate
    + aprobar(body): Map
  }
}

' ===== SERVICIOS =====
package "Service" {
  interface NotificacionPort {
    + enviarCredencialesTemporalesDirector(...): void
    + enviarCredencialesTemporalesAyudante(...): void
  }

  class NotificacionService {
    - emailService: EmailService
    - templates: EmailTemplates
    - proyectoRepo: ProyectoRepo
    + enviarCredencialesTemporalesDirector(...): void
    + enviarCredencialesTemporalesAyudante(...): void
  }

  class EmailService {
    - mailSender: JavaMailSender
    + sendPlainText(to, subject, body): void
  }

  class EmailTemplates {
    + credencialesDirector(...): String
    + credencialesAyudante(...): String
  }

  class ProfesorImporter {
    - jdbc: JdbcTemplate
    + run(args): void
  }
}

' ===== CONFIGURACIÓN =====
package "Config" {
  class SecurityConfig {
    + userDetailsService(repo): UserDetailsService
    + filterChain(http): SecurityFilterChain
  }

  class AsyncConfig {
  }
}

' ===== DTOs =====
package "DTO" {
  class RegistrarAyudanteReq {
    + nombres: String
    + apellidos: String
    + correoInstitucional: String
    + facultad: String
    + quintil: Integer
    + tipoAyudante: String
    + fechaInicioContrato: String
    + fechaFinContrato: String
  }

  class CrearProyectoReq {
    + codigo: String
    + nombre: String
    + correoDirector: String
  }

  class ActualizarProyectoReq {
    + fechaInicio: String
    + fechaFin: String
    + tipo: String
    + subtipo: String
    + maxAyudantes: Integer
    + maxArticulos: Integer
  }

  class CrearInformeSemanalReq {
    + fechaInicioSemana: String
    + fechaFinSemana: String
    + actividadesRealizadas: String
    + observaciones: String
    + anexos: String
  }

  class CrearActividadReq {
    + horaInicio: String
    + horaSalida: String
    + descripcion: String
  }

  class CambiarPasswordReq {
    + nuevaPassword: String
  }

  class FinalizarContratoReq {
    + motivo: String
  }

  class RevisarBitacoraReq {
    + decision: String
    + observacion: String
  }
}

' ===== RELACIONES PRINCIPALES =====

' Relaciones del Dominio (Composición/Agregación)
Proyecto "1" o-- "*" Contrato : tiene
Ayudante "1" o-- "*" Contrato : participa en
Contrato "1" o-- "*" BitacoraMensual : genera
BitacoraMensual "1" o-- "*" InformeSemanal : contiene
InformeSemanal "1" o-- "*" Actividad : registra
Usuario <|-- "1" Profesor : puede ser
Usuario <|-- "1" Ayudante : puede ser

' Controladores -> Repositorios (Dependencia)
AuthController --> UsuarioRepo
JefaturaController --> ProyectoRepo
JefaturaController --> UsuarioRepo
JefaturaController --> ProfesorRepo
JefaturaController --> ContratoRepo
JefaturaController --> BitacoraRepo
DirectorController --> "JdbcTemplate"
DirectorProyectoController --> ProyectoRepo
DirectorAyudantesController --> AyudanteRepo
DirectorAyudantesController --> ContratoRepo
DirectorAyudantesController --> UsuarioRepo
DirectorAyudantesController --> ProyectoRepo
DirectorBitacoraController --> BitacoraRepo
DirectorBitacoraController --> InformeSemanalRepo
DirectorBitacoraController --> ActividadRepo
AyudanteBitacoraController --> ContratoRepo
AyudanteBitacoraController --> BitacoraRepo
AyudanteBitacoraController --> InformeSemanalRepo
AyudanteBitacoraController --> ActividadRepo
CommonController --> UsuarioRepo
DebugController --> UsuarioRepo
BitacoraDebugController --> "JdbcTemplate"

' Controladores -> Servicios (Dependencia)
JefaturaController --> NotificacionPort
DirectorAyudantesController --> NotificacionPort

' Controladores -> DTOs (Uso)
DirectorAyudantesController ..> RegistrarAyudanteReq
DirectorAyudantesController ..> FinalizarContratoReq
JefaturaController ..> CrearProyectoReq
DirectorProyectoController ..> ActualizarProyectoReq
AyudanteBitacoraController ..> CrearInformeSemanalReq
AyudanteBitacoraController ..> CrearActividadReq
AuthController ..> CambiarPasswordReq
DirectorBitacoraController ..> RevisarBitacoraReq

' Servicios -> Servicios (Implementación y Dependencia)
NotificacionService ..|> NotificacionPort : implementa
NotificacionService --> EmailService
NotificacionService --> EmailTemplates
NotificacionService --> ProyectoRepo

' Repositorios -> Entidades (Creación/Gestión)
UsuarioRepo ..> Usuario : gestiona
ProfesorRepo ..> Profesor : gestiona
AyudanteRepo ..> Ayudante : gestiona
ContratoRepo ..> Contrato : gestiona
ProyectoRepo ..> Proyecto : gestiona
BitacoraRepo ..> BitacoraMensual : gestiona
InformeSemanalRepo ..> InformeSemanal : gestiona
ActividadRepo ..> Actividad : gestiona

' Repositorios -> JdbcTemplate (Dependencia)
UsuarioRepo --> "JdbcTemplate"
ProfesorRepo --> "JdbcTemplate"
AyudanteRepo --> "JdbcTemplate"
ContratoRepo --> "JdbcTemplate"
ProyectoRepo --> "JdbcTemplate"
BitacoraRepo --> "JdbcTemplate"
InformeSemanalRepo --> "JdbcTemplate"
ActividadRepo --> "JdbcTemplate"

' Config -> Repositorios (Uso)
SecurityConfig --> UsuarioRepo

' Services -> Spring Components
EmailService --> "JavaMailSender"
ProfesorImporter --> "JdbcTemplate"

@enduml